{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\r\n * Created with @iobroker/create-adapter v2.6.1\r\n */\r\n\r\n// The adapter-core module gives you access to the core ioBroker functions\r\n// you need to create an adapter\r\nimport * as utils from '@iobroker/adapter-core';\r\nimport { getStates } from './states';\r\nimport { CommonState, Login, TagResponse, WaterkotteError } from './types';\r\nimport { WaterkotteCgi } from './waterkotte';\r\n\r\n// Load your modules here, e.g.:\r\n// import * as fs from \"fs\";\r\n\r\nclass WaterkotteEasycon extends utils.Adapter {\r\n    states: CommonState[] = [];\r\n    api: WaterkotteCgi | undefined;\r\n    updateParametersInterval: ioBroker.Interval | undefined;\r\n    login: Login = <Login>{};\r\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n        super({\r\n            ...options,\r\n            name: 'waterkotte-easycon',\r\n        });\r\n        this.on('ready', this.onReady.bind(this));\r\n        //this.on('stateChange', this.onStateChange.bind(this));\r\n        //this.on('objectChange', this.onObjectChange.bind(this));\r\n        //this.on('message', this.onMessage.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Is called when databases are connected and adapter received configuration.\r\n     */\r\n    private async onReady(): Promise<void> {\r\n        this.setStateAsync('info.connection', false, true);\r\n\r\n        this.api = new WaterkotteCgi(this.config.ipAddress, this.log);\r\n\r\n        try {\r\n            this.login = await this.api.loginAsync(this.config.username, this.config.password);\r\n            await this.setStateAsync('info.connection', true, true);\r\n            await this.setErrorAsync('');\r\n        } catch (e: unknown) {\r\n            let message = String(e);\r\n            this.log.warn('error ' + message);\r\n            if (e instanceof WaterkotteError) {\r\n                message = `${e.code} - ${e.message}`;\r\n            }\r\n\r\n            this.log.error(message);\r\n            await this.setErrorAsync(message);\r\n            return;\r\n        }\r\n\r\n        this.states = getStates(\r\n            this.config.pollStatesOf ?? ['Heizen', 'K\u00FChlen', 'Wasser', 'Energiebilanz', 'Messwerte', 'Status'],\r\n        );\r\n\r\n        await this.updateParametersAsync(this.states);\r\n        const interval = this.setInterval(\r\n            async (states) => await this.updateParametersAsync(states as CommonState[]),\r\n            this.config.pollingInterval,\r\n            this.states,\r\n        );\r\n\r\n        if (interval) {\r\n            this.updateParametersInterval = interval;\r\n        }\r\n    }\r\n\r\n    private async updateParametersAsync(states: CommonState[]): Promise<void> {\r\n        if (!this.api) {\r\n            throw new Error('Unable to update parameters because api has not been initialized');\r\n        }\r\n\r\n        try {\r\n            const tagResponses = await this.api.getTagsAsync(states, this.login);\r\n\r\n            for (const tagResponse of tagResponses) {\r\n                if (tagResponse.response.status != TagResponse.STATUS_OK) {\r\n                    this.log.warn(\r\n                        `Unable to get parameter '${tagResponse.response.name}'. Received '${tagResponse.response.status}' instead.`,\r\n                    );\r\n                    continue;\r\n                }\r\n\r\n                if (!tagResponse.state) {\r\n                    continue;\r\n                }\r\n\r\n                const id = tagResponse.state.getStateId();\r\n                await this.extendObjectAsync(id, {\r\n                    type: 'state',\r\n                    common: tagResponse.state.getCommonObject(),\r\n                    native: {},\r\n                });\r\n\r\n                await this.setStateAsync(\r\n                    id,\r\n                    tagResponse.state.normalizeValue(Number(tagResponse.response.value)),\r\n                    true,\r\n                );\r\n            }\r\n        } catch (e: unknown) {\r\n            let message: string = 'unknown';\r\n            if (e instanceof WaterkotteError) {\r\n                message = `Received unknown error from heat pump: ${e.code} - ${e.message}`;\r\n            } else if (typeof e === 'string') {\r\n                message = e;\r\n            } else if (e instanceof Error) {\r\n                message = e.message;\r\n            }\r\n            this.log.warn(`Error during update: '${message}'`);\r\n            await this.setErrorAsync(message);\r\n        }\r\n    }\r\n\r\n    private async setErrorAsync(message: string): Promise<void> {\r\n        await this.extendObjectAsync('info.lastError', {\r\n            type: 'state',\r\n            common: {\r\n                write: false,\r\n                type: 'string',\r\n            },\r\n            native: {},\r\n        });\r\n        await this.setStateAsync('info.lastError', message, true);\r\n    }\r\n\r\n    /**\r\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\r\n     */\r\n    private onUnload(callback: () => void): void {\r\n        try {\r\n            clearInterval(this.updateParametersInterval);\r\n            try {\r\n                this.api?.logoutAsync().then().finally();\r\n            } catch {} // fire and forget\r\n\r\n            callback();\r\n        } catch (e) {\r\n            callback();\r\n        }\r\n    }\r\n\r\n    // If you need to react to object changes, uncomment the following block and the corresponding line in the constructor.\r\n    // You also need to subscribe to the objects with `this.subscribeObjects`, similar to `this.subscribeStates`.\r\n    // /**\r\n    //  * Is called if a subscribed object changes\r\n    //  */\r\n    // private onObjectChange(id: string, obj: ioBroker.Object | null | undefined): void {\r\n    //     if (obj) {\r\n    //         // The object was changed\r\n    //         this.log.info(`object ${id} changed: ${JSON.stringify(obj)}`);\r\n    //     } else {\r\n    //         // The object was deleted\r\n    //         this.log.info(`object ${id} deleted`);\r\n    //     }\r\n    // }\r\n\r\n    /**\r\n     * Is called if a subscribed state changes\r\n     */\r\n    private onStateChange(id: string, state: ioBroker.State | null | undefined): void {\r\n        if (state) {\r\n            // The state was changed\r\n            this.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\r\n        } else {\r\n            // The state was deleted\r\n            this.log.info(`state ${id} deleted`);\r\n        }\r\n    }\r\n\r\n    // If you need to accept messages in your adapter, uncomment the following block and the corresponding line in the constructor.\r\n    // /**\r\n    //  * Some message was sent to this instance over message box. Used by email, pushover, text2speech, ...\r\n    //  * Using this method requires \"common.messagebox\" property to be set to true in io-package.json\r\n    //  */\r\n    // private onMessage(obj: ioBroker.Message): void {\r\n    //     if (typeof obj === 'object' && obj.message) {\r\n    //         if (obj.command === 'send') {\r\n    //             // e.g. send email or pushover or whatever\r\n    //             this.log.info('send command');\r\n\r\n    //             // Send response in callback if required\r\n    //             if (obj.callback) this.sendTo(obj.from, obj.command, 'Message received', obj.callback);\r\n    //         }\r\n    //     }\r\n    // }\r\n}\r\n\r\nif (require.main !== module) {\r\n    // Export the constructor in compact mode\r\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new WaterkotteEasycon(options);\r\n} else {\r\n    // otherwise start the instance directly\r\n    (() => new WaterkotteEasycon())();\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
