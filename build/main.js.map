{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\r\n * Created with @iobroker/create-adapter v2.6.1\r\n */\r\n\r\n// The adapter-core module gives you access to the core ioBroker functions\r\n// you need to create an adapter\r\nimport * as utils from '@iobroker/adapter-core';\r\nimport { AdapterError, RethrowError, TagResponse, WaterkotteError } from './types';\r\nimport { WaterkotteHeatPump } from './waterkotteheatpump';\r\n\r\nclass WaterkotteEasycon extends utils.Adapter {\r\n    api: WaterkotteHeatPump | undefined;\r\n    updateParametersInterval: ioBroker.Interval | undefined;\r\n    knownObjects: Record<string, CacheItem> = {};\r\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n        super({\r\n            ...options,\r\n            name: 'waterkotte-easycon',\r\n        });\r\n        this.on('ready', this.onReady.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Is called when databases are connected and adapter received configuration.\r\n     */\r\n    private async onReady(): Promise<void> {\r\n        this.setStateAsync('info.connection', false, true);\r\n\r\n        this.knownObjects = {};\r\n        if (this.updateParametersInterval) {\r\n            this.clearInterval(this.updateParametersInterval);\r\n        }\r\n\r\n        if (!(await this.updateAndHandleConfigAsync())) {\r\n            return;\r\n        }\r\n\r\n        this.api = new WaterkotteHeatPump(this.config.ipAddress, this.config.username, this.config.password, this.log);\r\n\r\n        try {\r\n            const response = await this.updateParametersAsync();\r\n            if (response instanceof Error) {\r\n                let message: string | undefined = undefined;\r\n                if (response instanceof WaterkotteError) {\r\n                    message = `${response.code} - ${response.message}`;\r\n                }\r\n\r\n                this.log.error(`Unhandled error on adapter startup: ${(message ??= String(response))}`);\r\n                this.log.error(`Callstack: ${response.stack}`);\r\n                await this.setMessageStateAsync(message);\r\n                return;\r\n            }\r\n\r\n            this.log.info('Successfully logged in');\r\n            await this.setStateAsync('info.connection', true, true);\r\n            await this.setMessageStateAsync('');\r\n\r\n            const interval = this.setInterval(\r\n                async () => await this.updateParametersAsync(),\r\n                this.config.pollingInterval,\r\n            );\r\n\r\n            if (interval) {\r\n                this.updateParametersInterval = interval;\r\n            }\r\n        } catch (e: unknown) {\r\n            this.log.error(`Unhandled error on adapter startup: ${e}`);\r\n            if (e instanceof Error) {\r\n                this.log.error(`Callstack: ${e.stack}`);\r\n            }\r\n            await this.setMessageStateAsync(`Unhandled error on adapter startup: ${String(e)}`);\r\n            return;\r\n        }\r\n    }\r\n\r\n    private async checkConfig(): Promise<boolean> {\r\n        let configName: string = '';\r\n\r\n        if (!this.config.ipAddress) {\r\n            configName = 'ip address';\r\n        } else if (!this.config.username) {\r\n            configName = 'username';\r\n        } else if (!this.config.password) {\r\n            configName = 'password';\r\n        }\r\n\r\n        if (!configName) {\r\n            return true;\r\n        }\r\n\r\n        const message = `Unable to connect to heat pump: missing ${configName}`;\r\n        this.log.warn(message);\r\n        await this.setMessageStateAsync(message);\r\n\r\n        return false;\r\n    }\r\n\r\n    private async updateAndHandleConfigAsync(): Promise<boolean> {\r\n        if (!(await this.checkConfig())) {\r\n            return false;\r\n        }\r\n\r\n        const info = await this.getObjectAsync('info');\r\n        const lastConfig: ioBroker.AdapterConfig = <ioBroker.AdapterConfig>info?.native;\r\n\r\n        if (lastConfig) {\r\n            if (\r\n                lastConfig.pathFlavor != this.config.pathFlavor ||\r\n                lastConfig.removeWhitespace != this.config.removeWhitespace\r\n            ) {\r\n                this.log.debug('Config changed, delete all states');\r\n                await this.deleteAllObjectsAsync();\r\n            }\r\n        }\r\n\r\n        await this.extendObjectAsync('info', {\r\n            native: <ioBroker.AdapterConfig>{\r\n                pathFlavor: this.config.pathFlavor,\r\n                removeWhitespace: this.config.removeWhitespace,\r\n            },\r\n        });\r\n        return true;\r\n    }\r\n\r\n    private async deleteAllObjectsAsync(): Promise<boolean> {\r\n        const objects = await this.getObjectListAsync({\r\n            startkey: this.namespace,\r\n        });\r\n\r\n        if (objects.rows) {\r\n            const idRoot = this.namespace + '.';\r\n            const rootObjects = Array.from(\r\n                new Set(\r\n                    objects.rows\r\n                        .filter((x) => x.id.includes(idRoot))\r\n                        .map((x) => x.id.replace(idRoot, '').split('.')[0]),\r\n                ),\r\n            ).filter((x) => !x.startsWith('info'));\r\n\r\n            for (const obj of rootObjects) {\r\n                this.log.debug('delete ' + obj);\r\n                await this.delObjectAsync(obj, { recursive: true });\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    private async updateParametersAsync(): Promise<void | Error> {\r\n        if (!this.api) {\r\n            throw new AdapterError('Unable to update parameters because api has not been initialized');\r\n        }\r\n\r\n        try {\r\n            const tagResponses = await this.api.requestTagsAsync();\r\n\r\n            for (const tagResponse of tagResponses) {\r\n                if (tagResponse.response.status != TagResponse.STATUS_OK) {\r\n                    this.log.warn(\r\n                        `Unable to get parameter '${tagResponse.response.name}'. Received '${tagResponse.response.status}' instead.`,\r\n                    );\r\n                    continue;\r\n                }\r\n\r\n                if (!tagResponse.state) {\r\n                    continue;\r\n                }\r\n\r\n                const path = await this.createObjectIfNotExists(\r\n                    tagResponse.state.Id,\r\n                    () => {\r\n                        let path = tagResponse.state.getPath(\r\n                            this.config.pathFlavor,\r\n                            this.FORBIDDEN_CHARS,\r\n                            this.language ?? 'en',\r\n                        );\r\n                        if (this.config.removeWhitespace) {\r\n                            path = path.replaceAll(/\\s/g, '_');\r\n                        }\r\n                        return path;\r\n                    },\r\n                    () =>\r\n                        <ioBroker.PartialObject>{\r\n                            type: 'state',\r\n                            common: tagResponse.state.getCommonObject(),\r\n                            native: {\r\n                                id: tagResponse.state.Id,\r\n                            },\r\n                        },\r\n                    tagResponse.state,\r\n                );\r\n\r\n                await this.setStateAsync(path, tagResponse.state.normalizeValue(tagResponse.response.value), true);\r\n            }\r\n\r\n            await this.setMessageStateAsync('');\r\n        } catch (e: unknown) {\r\n            let returnError: Error;\r\n\r\n            if (e instanceof Error) {\r\n                if (e instanceof WaterkotteError) {\r\n                    returnError = e;\r\n                } else {\r\n                    returnError = new RethrowError(e);\r\n                }\r\n            } else {\r\n                returnError = new AdapterError(`Error during update: '${e}'`);\r\n            }\r\n\r\n            this.log.warn(returnError.message);\r\n            await this.setMessageStateAsync(returnError.message);\r\n            return returnError;\r\n        }\r\n    }\r\n\r\n    private async setMessageStateAsync(message: string): Promise<void> {\r\n        await this.createObjectIfNotExists(\r\n            'info.message',\r\n            () => 'info.message',\r\n            () =>\r\n                <ioBroker.PartialObject>{\r\n                    type: 'state',\r\n                    common: {\r\n                        write: false,\r\n                        type: 'string',\r\n                    },\r\n                    native: {},\r\n                },\r\n            message,\r\n        );\r\n        await this.setStateAsync('info.message', message, true);\r\n    }\r\n\r\n    private async createObjectIfNotExists(\r\n        id: string,\r\n        getPath: () => string,\r\n        getObjPart: () => ioBroker.PartialObject,\r\n        item: any,\r\n    ): Promise<string> {\r\n        const cachedItem = this.knownObjects[id];\r\n        const cachedItemPath = cachedItem?.['path'];\r\n        if (!cachedItemPath) {\r\n            const path = getPath();\r\n            await this.extendObjectAsync(path, getObjPart());\r\n            this.knownObjects[id] = { path: path, item: item };\r\n            this.log.silly(`${path} added to cache`);\r\n            return path;\r\n        } else {\r\n            this.log.silly(`${cachedItemPath} found in cache`);\r\n            return cachedItemPath;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\r\n     */\r\n    private onUnload(callback: () => void): void {\r\n        try {\r\n            this.clearInterval(this.updateParametersInterval);\r\n            try {\r\n                this.api\r\n                    ?.disconnectAsync()\r\n                    .then(() => {\r\n                        this.log.info('Successfully logged out');\r\n                    })\r\n                    .finally();\r\n            } catch {} // fire and forget\r\n\r\n            callback();\r\n        } catch (e) {\r\n            callback();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Is called if a subscribed state changes\r\n     */\r\n    private onStateChange(id: string, state: ioBroker.State | null | undefined): void {\r\n        if (state) {\r\n            // The state was changed\r\n            this.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\r\n        } else {\r\n            // The state was deleted\r\n            this.log.info(`state ${id} deleted`);\r\n        }\r\n    }\r\n}\r\n\r\nif (require.main !== module) {\r\n    // Export the constructor in compact mode\r\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new WaterkotteEasycon(options);\r\n} else {\r\n    // otherwise start the instance directly\r\n    (() => new WaterkotteEasycon())();\r\n}\r\n\r\ntype CacheItem = {\r\n    path: string;\r\n    item: any;\r\n};\r\n"],
  "mappings": "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",
  "names": ["path"]
}
